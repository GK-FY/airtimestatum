<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>FY Bot â€” Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Inter,Arial;background:#f6fbff;color:#061226;padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 12px 32px rgba(8,18,40,0.06);margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:13px;text-align:left}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef;width:100%}
    button{padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,#0f6fc8,#2563eb);color:#fff;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 320px;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>FY Bot Admin</h3>
      <div class="row" style="align-items:center">
        <div><input id="q" placeholder="Search order no / mpesa code / payer"></div>
        <div><select id="filter"><option value="all">All</option><option value="paid">Paid</option><option value="pending">Pending</option><option value="cancelled">Failed/Cancelled</option></select></div>
      </div>
      <div style="margin-top:8px">
        <button id="searchBtn">Search</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="card" id="resultsCard">
      <h4>Orders</h4>
      <div id="ordersWrap">Loading...</div>
    </div>

    <div class="card">
      <h4>Settings</h4>
      <div id="settingsWrap">Loading settings...</div>
    </div>
  </div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token') || '';

  function api(path, opts = {}) {
    opts.headers = opts.headers || {};
    if (token) opts.headers['x-admin-token'] = token;
    return fetch(path, opts).then(r => r.json());
  }

  async function loadOrders() {
    const q = document.getElementById('q').value;
    const filter = document.getElementById('filter').value;
    const out = await api(`/admin/orders?filter=${encodeURIComponent(filter)}&q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`);
    const wrap = document.getElementById('ordersWrap');
    if (!out.success) { wrap.innerText = 'Error: ' + out.message; return; }
    if (!out.orders.length) { wrap.innerText = 'No orders'; return; }
    let html = '<table><thead><tr><th>#</th><th>Order</th><th>Payer</th><th>Recipient</th><th>Amt</th><th>Payable</th><th>Status</th><th>MPesa</th><th>Created</th></tr></thead><tbody>';
    out.orders.forEach(o => {
      html += `<tr>
        <td>${o.id}</td>
        <td><a href="#" onclick="viewOrder('${o.order_no}');return false">${o.order_no}</a></td>
        <td>${o.payer_number}</td>
        <td>${o.recipient_number}</td>
        <td>KES ${parseFloat(o.amount).toFixed(2)}</td>
        <td>KES ${parseFloat(o.amount_payable).toFixed(2)}</td>
        <td>${o.status}</td>
        <td>${o.transaction_code || 'N/A'}</td>
        <td>${o.created_at}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  async function viewOrder(orderNo){
    const out = await api(`/admin/order/${encodeURIComponent(orderNo)}?token=${encodeURIComponent(token)}`);
    if (!out.success) return alert('Not found');
    const o = out.order;
    alert(`Order: ${o.order_no}\nPayer: ${o.payer_number}\nRecipient: ${o.recipient_number}\nAmount: KES ${parseFloat(o.amount).toFixed(2)}\nPayable: KES ${parseFloat(o.amount_payable).toFixed(2)}\nStatus: ${o.status}\nMPesa: ${o.transaction_code || 'N/A'}\nCreated: ${o.created_at}\nAirtime: ${o.airtime_status || 'N/A'}`);
  }

  async function loadSettings(){
    const out = await api(`/admin/settings?token=${encodeURIComponent(token)}`);
    const wrap = document.getElementById('settingsWrap');
    if (!out.success) { wrap.innerText = 'Error loading settings'; return; }
    const s = out.settings;
    wrap.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>Statum Consumer Key</label><input id="statum_consumer_key" value="${s.statum_consumer_key || ''}"></div>
        <div><label>Statum Secret</label><input id="statum_consumer_secret" value="${s.statum_consumer_secret || ''}"></div>
        <div><label>Shadow API Key</label><input id="shadow_api_key" value="${s.shadow_api_key || ''}"></div>
        <div><label>Shadow API Secret</label><input id="shadow_api_secret" value="${s.shadow_api_secret || ''}"></div>
        <div><label>Shadow Account ID</label><input id="shadow_account_id" value="${s.shadow_account_id || ''}"></div>
        <div><label>Payment Poll Seconds</label><input id="payment_poll_seconds" value="${s.payment_poll_seconds || ''}"></div>
      </div>
      <div style="margin-top:8px"><button id="saveSettingsBtn">Save Settings</button></div>
    `;
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      const payload = {
        statum_consumer_key: document.getElementById('statum_consumer_key').value,
        statum_consumer_secret: document.getElementById('statum_consumer_secret').value,
        shadow_api_key: document.getElementById('shadow_api_key').value,
        shadow_api_secret: document.getElementById('shadow_api_secret').value,
        shadow_account_id: document.getElementById('shadow_account_id').value,
        payment_poll_seconds: document.getElementById('payment_poll_seconds').value
      };
      const res = await api('/admin/settings', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      if (res.success) alert('Saved'); else alert('Error: ' + res.message);
    });
  }

  document.getElementById('searchBtn').addEventListener('click', loadOrders);
  document.getElementById('refreshBtn').addEventListener('click', loadOrders);

  loadOrders();
  loadSettings();
</script>
</body>
</html>
